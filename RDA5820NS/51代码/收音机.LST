C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE 收音_
OBJECT MODULE PLACED IN 收音机.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 收音机.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "stc12c5608.h" 
   2          ////////////////////////////////////////////////
   3          #define read_add 0x23
   4          #define write_add 0x22
   5           
   6          ////////////////////////////////////////////////在这里写地址
   7          sbit en=P1^7;
   8          sbit rw=P2^0;
   9          sbit rs=P2^1;
  10          sbit d0=P1^6;
  11          sbit d1=P1^5;
  12          sbit d2=P1^4;
  13          sbit d3=P1^3;
  14          sbit d4=P1^2;
  15          sbit d5=P1^1;
  16          sbit d6=P1^0;
  17          sbit d7=P3^7;
  18          ///////////////////////////////////////////////////////////////
  19          sbit scl=P2^4;
  20          sbit sda=P2^5;
  21          sbit led=P3^5;
  22          
  23          sbit s1=P2^2;
  24          sbit s2=P2^3;
  25          sbit s3=P3^2;
  26          
  27          ////////////////////////////////////////////////////////////////
  28          unsigned char code dis_table_num[]="0123456789";
  29          unsigned char code dis_table_rx[]="  FM RECEIVER   ";
  30          unsigned char code dis_table_rxs[]=" -FM RECEIVER-  ";
  31          unsigned char code dis_table_rx_autos[]="     -AUTO-     ";
  32          unsigned char code dis_table_rx_auto[]="      AUTO      ";
  33          unsigned char code dis_table_rx_manuals[]="    -MANUAL-    ";
  34          unsigned char code dis_table_rx_manual[]="     MANUAL     ";
  35          unsigned char code dis_table_tx[]=" FM TRANSMITTER ";
  36          unsigned char code dis_table_txs[]="-FM TRANSMITTER-";
  37          unsigned char code dis_table_start[]="    WELCOME     ";
  38          unsigned char code dis_table_wait[]=" .............. ";
  39          unsigned char code dis_table_power[]="   SET POWER    ";
  40          /////////////////////////////////////////////////
  41          void delay_1ms(unsigned int num)
  42          {
  43   1        unsigned int i,c;
  44   1        for(i=num;i>0;i--)
  45   1               for(c=70;c>0;c--);
  46   1      }
  47          void delay_nop()
  48          {;;;;}
  49          ///////////////////////////////////
  50          /********************************************************
  51                               下面是1602
  52          ********************************************************/
  53          unsigned code LevlChar[5][8] =
  54          {{0x1F,0x11,0x0A,0x04,0x04,0x04,0x04,0x04},
  55          {0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x1E},
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 2   

  56          {0x00,0x00,0x00,0x00,0x06,0x1E,0x1E,0x1E},     //显示型号强度的自定义字符
  57          {0x00,0x00,0x06,0x1E,0x1E,0x1E,0x1E,0x1E},
  58          {0x06,0x1E,0x1E,0x1E,0x1E,0x1E,0x1E,0x1E}};  
  59          /////////////////////////////////////////////////
  60          
  61          void write_com_1602(unsigned char com)
  62          { 
  63   1        unsigned char temp;
  64   1        temp=com;
  65   1        rs=0;
  66   1        temp=temp<<1;
  67   1        d7=CY;
  68   1        temp=temp<<1;
  69   1        d6=CY;
  70   1        temp=temp<<1;
  71   1        d5=CY;
  72   1        temp=temp<<1;
  73   1        d4=CY;
  74   1        temp=temp<<1;
  75   1        d3=CY;
  76   1        temp=temp<<1;
  77   1        d2=CY;
  78   1        temp=temp<<1;
  79   1        d1=CY;
  80   1        temp=temp<<1;
  81   1        d0=CY;
  82   1        delay_1ms(5);
  83   1        en=1;
  84   1        delay_1ms(5);
  85   1        en=0;
  86   1      }
  87          void write_data_1602(unsigned char date)
  88          { 
  89   1         unsigned char temp;
  90   1         temp=date;
  91   1         rs=1;
  92   1        temp=temp<<1;
  93   1        d7=CY;
  94   1        temp=temp<<1;
  95   1        d6=CY;
  96   1        temp=temp<<1;
  97   1        d5=CY;
  98   1        temp=temp<<1;
  99   1        d4=CY;
 100   1        temp=temp<<1;
 101   1        d3=CY;
 102   1        temp=temp<<1;
 103   1        d2=CY;
 104   1        temp=temp<<1;
 105   1        d1=CY;
 106   1        temp=temp<<1;
 107   1        d0=CY;
 108   1         delay_1ms(5);
 109   1         en=1;
 110   1         delay_1ms(5);
 111   1         en=0;
 112   1      }
 113          void init_1602()
 114          {  unsigned char i,j;
 115   1         unsigned char CGRamAddr = 0x40;
 116   1         en=0;
 117   1         rw=0;
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 3   

 118   1         rs=0;
 119   1         write_com_1602(0x38);
 120   1         write_com_1602(0x0c);
 121   1         write_com_1602(0x06);
 122   1         write_com_1602(0x01); 
 123   1           for(j=0;j<5;j++)
 124   1               {
 125   2        write_com_1602(CGRamAddr + 8*j); //建立自定义字符 (显示信号强度的)
 126   2           for(i=0;i<8;i++) 
 127   2        {
 128   3        write_data_1602(LevlChar[j][i]);
 129   3         
 130   3        }
 131   2      }
 132   1      }
 133          /********************************************************
 134                             以下是i2c
 135          *********************************************************/
 136          /////////////////////////////////////////////////////延时
 137          void init_i2c()
 138          {
 139   1         sda=1;
 140   1         delay_nop();
 141   1         scl=1;
 142   1         delay_nop();
 143   1      }
 144          void start_i2c()
 145          {
 146   1         scl=1;
 147   1         delay_nop();
 148   1         sda=1;
 149   1         delay_nop();
 150   1         sda=0;
 151   1         delay_nop();
 152   1         
 153   1         
 154   1         
 155   1      }
 156          void stop_i2c()
 157          {
 158   1        sda=0;
 159   1        delay_nop();
 160   1        scl=1;
 161   1        delay_nop();
 162   1        sda=1;
 163   1        delay_nop();
 164   1      }
 165          void ac_i2c()
 166          { 
 167   1        scl=0;
 168   1        delay_nop(); 
 169   1        sda=0;
 170   1        delay_nop();
 171   1        delay_nop();
 172   1        scl=1;
 173   1        delay_nop();
 174   1        scl=0;
 175   1       
 176   1      }
 177          void no_ac_i2c()
 178          { 
 179   1        scl=0;
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 4   

 180   1        delay_nop(); 
 181   1        sda=1;
 182   1        delay_nop();
 183   1        delay_nop();
 184   1        scl=1;
 185   1        delay_nop();
 186   1        scl=0;
 187   1       
 188   1      }
 189          void respons_i2c()
 190          {
 191   1        unsigned char i;
 192   1        sda=1;
 193   1        delay_nop();
 194   1        scl=1;
 195   1        delay_nop();
 196   1        while((sda==1)&&(i<250))
 197   1        {i++;}
 198   1        scl=0;
 199   1        delay_nop();
 200   1      
 201   1      }
 202          void write_byte_i2c(unsigned char dt)
 203          {
 204   1        unsigned char temp,i;
 205   1        temp=dt;
 206   1        for(i=0;i<8;i++)
 207   1        {
 208   2             temp=temp<<1;
 209   2                 scl=0;
 210   2                 delay_nop();
 211   2                 sda=CY;
 212   2                 delay_nop();
 213   2                 scl=1;
 214   2                 delay_nop();
 215   2      
 216   2        }
 217   1        scl=0;
 218   1        delay_nop();
 219   1        sda=1;
 220   1        delay_nop();
 221   1      
 222   1      }
 223          unsigned char read_byte_i2c()
 224          {
 225   1          unsigned int i,dt;
 226   1              scl=0;
 227   1              delay_nop();
 228   1              sda=1;
 229   1              delay_nop();
 230   1              for(i=0;i<8;i++)
 231   1              {
 232   2                scl=1;
 233   2                delay_nop();
 234   2                dt=(dt<<1)|sda;
 235   2                scl=0;
 236   2                delay_nop();
 237   2              }
 238   1          delay_nop();
 239   1              delay_nop();
 240   1      
 241   1              return dt;
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 5   

 242   1      }
 243          void write_i2c(unsigned char add,int dt)
 244          {         
 245   1            int temp;
 246   1            temp=dt;
 247   1                temp=temp>>8;
 248   1            start_i2c();
 249   1                write_byte_i2c(write_add);
 250   1                respons_i2c();
 251   1                write_byte_i2c(add);
 252   1                respons_i2c();
 253   1                write_byte_i2c((unsigned char)(temp));
 254   1                respons_i2c();
 255   1                write_byte_i2c((unsigned char)(dt));
 256   1                respons_i2c();
 257   1                stop_i2c();
 258   1      }
 259          unsigned int read_i2c(unsigned char add)
 260          {
 261   1            unsigned int temp1,temp2,dt;
 262   1                temp1=0;
 263   1                temp2=0;
 264   1            start_i2c();
 265   1                write_byte_i2c(write_add);
 266   1                respons_i2c();
 267   1                write_byte_i2c(add);
 268   1                respons_i2c();
 269   1                ///////////////
 270   1                delay_1ms(5);
 271   1                start_i2c();
 272   1                write_byte_i2c(read_add);
 273   1                respons_i2c();
 274   1                temp1=read_byte_i2c();
 275   1                ac_i2c();
 276   1                temp2=read_byte_i2c();
 277   1                no_ac_i2c(); 
 278   1                stop_i2c();
 279   1                temp1=(temp1<<8);
 280   1                dt=(temp1|temp2);
 281   1                return dt;
 282   1           
 283   1      }
 284           
 285          /*************************************************************/
 286          //unsigned int get_adc()
 287          //{                                      
 288          //     unsigned int result;
 289          //     ADC_CONTR=0xe0;
 290          //     delay_1ms(10);
 291          //     ADC_CONTR=ADC_CONTR|0x08;
 292          //       delay_1ms(10);
 293          //       while(!(ADC_CONTR&0x10));
 294          //       result=ADC_DATA;
 295          //       result=result<<2;
 296          //       result=result|ADC_LOW2;
 297          //       return result;
 298          //}
 299          unsigned char scan_key() //扫描按键
 300          {        
 301   1      //     unsigned int result;
 302   1           unsigned char key_num=0;
 303   1      //     result=get_adc();
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 6   

 304   1      //       if(result<0x0199) //按键1按下
 305   1      //       { 
 306   1      //         key_num=1;
 307   1      //         led=1;         
 308   1      //         while(get_adc()<0x332); 
 309   1      //         led=0;
 310   1      //       }
 311   1      //       if(result>0x0199&&result<0x0232) //按键2按下
 312   1      //       {
 313   1      //         key_num=2;
 314   1      //         led=1;
 315   1      //         while(get_adc()<0x332); 
 316   1      //         led=0;
 317   1      //       }
 318   1      //       if(result>0x0232&&result<0x332) //按键3按下
 319   1      //       {
 320   1      //         key_num=3;
 321   1      //         led=1; 
 322   1      //          while(get_adc()<0x332);
 323   1      //         led=0;
 324   1      //       }
 325   1      
 326   1              if(s1==0)
 327   1              {
 328   2                      delay_1ms(10);
 329   2                      if(s1==0)
 330   2                      {
 331   3                              while(!s1);
 332   3                              key_num=1;
 333   3                      }
 334   2              }
 335   1              if(s2==0)
 336   1              {
 337   2                      delay_1ms(10);
 338   2                      if(s2==0)
 339   2                      {
 340   3                              while(!s2);
 341   3                              key_num=2;
 342   3                      }
 343   2              }
 344   1              if(s3==0)
 345   1              {
 346   2                      delay_1ms(10);
 347   2                      if(s3==0)
 348   2                      {
 349   3                              while(!s3);
 350   3                              key_num=3;
 351   3                      }
 352   2              }
 353   1      
 354   1               return key_num;
 355   1      
 356   1      }
 357          void dis_clear(bit num)  //清屏
 358          {
 359   1         unsigned char i;      
 360   1         if(num==1)
 361   1         { write_com_1602(0x80);
 362   2           for(i=0;i<16;i++)
 363   2               {write_data_1602(' ');}
 364   2               write_com_1602(0xc0);
 365   2           for(i=0;i<16;i++)
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 7   

 366   2               {write_data_1602(' ');} 
 367   2         }
 368   1         else
 369   1         {
 370   2            write_com_1602(0x80);
 371   2           for(i=0;i<5;i++)
 372   2               {write_data_1602(' ');}
 373   2         } 
 374   1      }
 375          void dis_wait()
 376          {
 377   1          unsigned char i;
 378   1              dis_clear(1);
 379   1          write_com_1602(0xc0);
 380   1              for(i=0;i<16;i++)
 381   1              {
 382   2                 write_data_1602(dis_table_wait[i]);
 383   2                 delay_1ms(300);
 384   2              }
 385   1      }
 386          unsigned int auto_seek(unsigned int fm_fre,bit up_dowm)    //自动搜索返回当前频率
 387          {                       
 388   1           unsigned int temp=0,mode=0;
 389   1           bit stc=0;
 390   1               dis_wait();
 391   1               fm_fre=fm_fre<<6;      
 392   1           write_i2c(0x03,(0x0010|fm_fre));
 393   1               if(up_dowm==1)
 394   1                 {mode=0xd381;}
 395   1               else
 396   1                 {mode=0xd181; }
 397   1           do
 398   1            { 
 399   2                 delay_1ms(10);
 400   2                 write_i2c(0x02,mode);                                
 401   2                 temp=read_i2c(0x0a);
 402   2                 temp=temp<<2;
 403   2                 stc=CY;
 404   2                 }while(stc==0);
 405   1                fm_fre=(read_i2c(0x0a)&0x03ff);
 406   1                write_i2c(0x02,0xd281);
 407   1                return fm_fre;
 408   1                              
 409   1      }
 410          void dis_fm_fre(bit num)           //显示频率
 411          {       
 412   1          unsigned int fm_fre=0;
 413   1          
 414   1              if(num==0)
 415   1              {
 416   2              fm_fre=(read_i2c(0x0a)&0x03ff);
 417   2          fm_fre=fm_fre+870;
 418   2          write_com_1602(0xc3);
 419   2              write_data_1602('F');
 420   2              write_data_1602('M');
 421   2              write_data_1602(':');
 422   2              write_data_1602(dis_table_num[fm_fre/1000]);
 423   2              write_data_1602(dis_table_num[(fm_fre%1000)/100]);
 424   2              write_data_1602(dis_table_num[((fm_fre%100)/10)]);
 425   2              write_data_1602('.');
 426   2              write_data_1602(dis_table_num[fm_fre%10]);
 427   2              }
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 8   

 428   1              else
 429   1              {
 430   2      //      fm_fre=(read_i2c(0x0a)&0x03ff);
 431   2          fm_fre=(read_i2c(0x03)>>6);
 432   2          fm_fre=fm_fre+760;
 433   2          write_com_1602(0xc3);
 434   2              write_data_1602('F');
 435   2              write_data_1602('M');
 436   2              write_data_1602(':');
 437   2              write_data_1602(dis_table_num[fm_fre/1000]);
 438   2              write_data_1602(dis_table_num[(fm_fre%1000)/100]);
 439   2              write_data_1602(dis_table_num[((fm_fre%100)/10)]);
 440   2              write_data_1602('.');
 441   2              write_data_1602(dis_table_num[fm_fre%10]);
 442   2              }
 443   1      }
 444          
 445          void dis_volume() //显示声音
 446          {   
 447   1              unsigned char volume;
 448   1              volume=read_i2c(0x05);
 449   1              volume=(volume&0x000f);
 450   1              write_com_1602(0x87);
 451   1              write_data_1602('V');
 452   1              write_data_1602(':');
 453   1              write_data_1602(dis_table_num[(volume/10)]);
 454   1              write_data_1602(dis_table_num[(volume%10)]);
 455   1      
 456   1      }
 457          void dis_mode(bit num)          //显示模式参数为1时发射，为0时接收
 458          {
 459   1           write_com_1602(0x8c);
 460   1               if(num==0)
 461   1               {
 462   2                 write_data_1602('R');
 463   2                 write_data_1602('X');
 464   2               }
 465   1               else
 466   1               {
 467   2                 write_data_1602('T');
 468   2                 write_data_1602('X');
 469   2               }
 470   1      }
 471          void dis_power_tx(bit num)
 472          {
 473   1          unsigned int power;
 474   1              unsigned char i;
 475   1              power=(read_i2c(0x42)&0x003f);
 476   1              if(num==0)
 477   1              {
 478   2              write_com_1602(0x80);
 479   2              for(i=0;i<16;i++)
 480   2              {write_data_1602(dis_table_power[i]);}
 481   2              write_com_1602(0xc6);
 482   2              if(power<0x0f)
 483   2              {//write_data_1602(0x00);
 484   3              write_data_1602(0x01);}
 485   2              else if(power<0x20)
 486   2              {//write_data_1602(0x00);
 487   3              write_data_1602(0x01);
 488   3              write_data_1602(0x02);}
 489   2              else if(power<0x30)
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 9   

 490   2          {//write_data_1602(0x00);
 491   3              write_data_1602(0x01);
 492   3              write_data_1602(0x02);
 493   3              write_data_1602(0x03);}
 494   2              else if(power<0x40)
 495   2              {//write_data_1602(0x00);
 496   3              write_data_1602(0x01);
 497   3              write_data_1602(0x02);
 498   3              write_data_1602(0x03);
 499   3          write_data_1602(0x04);}
 500   2              }
 501   1              else
 502   1              {
 503   2              write_com_1602(0x80);
 504   2              if(power<0x0f)
 505   2              {//write_data_1602(0x00);
 506   3              write_data_1602(0x01);}
 507   2              else if(power<0x20)
 508   2              {//write_data_1602(0x00);
 509   3              write_data_1602(0x01);
 510   3              write_data_1602(0x02);}
 511   2              else if(power<0x30)
 512   2          {//write_data_1602(0x00);
 513   3              write_data_1602(0x01);
 514   3              write_data_1602(0x02);
 515   3              write_data_1602(0x03);}
 516   2              else if(power<0x40)
 517   2              {//write_data_1602(0x00);
 518   3              write_data_1602(0x01);
 519   3              write_data_1602(0x02);
 520   3              write_data_1602(0x03);
 521   3          write_data_1602(0x04);}
 522   2              }
 523   1      
 524   1      }
 525          
 526          void dis_rssi()         //显示信号
 527          {       
 528   1          unsigned int rssi;
 529   1          dis_clear(0);
 530   1              rssi=read_i2c(0x0b);
 531   1              rssi=rssi>>10; 
 532   1              write_com_1602(0x80);
 533   1              if(rssi<0x07)
 534   1              {//write_data_1602(0x00);
 535   2              write_data_1602(0x01);}
 536   1              else if(rssi<0x0e)
 537   1              {//write_data_1602(0x00);
 538   2              write_data_1602(0x01);
 539   2              write_data_1602(0x02);}
 540   1              else if(rssi<0x15)
 541   1          {//write_data_1602(0x00);
 542   2              write_data_1602(0x01);
 543   2              write_data_1602(0x02);
 544   2              write_data_1602(0x03);}
 545   1              else if(rssi<0x1c)
 546   1              {//write_data_1602(0x00);
 547   2              write_data_1602(0x01);
 548   2              write_data_1602(0x02);
 549   2              write_data_1602(0x03);
 550   2          write_data_1602(0x04);}
 551   1      }
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 10  

 552          void set_volume(unsigned int num)
 553          {
 554   1         write_i2c(0x05,(num|0x83a0));
 555   1         
 556   1      }
 557          void set_power_tx(unsigned int power)
 558           
 559          {
 560   1         write_i2c(0x42,(0x0700|power));    
 561   1      }
 562          void set_fm_fre_rx(unsigned int fm_fre)
 563          {
 564   1          fm_fre=fm_fre<<6;
 565   1              write_i2c(0x02,0xd281);
 566   1              write_i2c(0x03,(0x0010|fm_fre));
 567   1              delay_1ms(20);
 568   1      }
 569          void set_fm_fre_tx(unsigned int fm_fre)
 570          {
 571   1          fm_fre=fm_fre<<6;
 572   1              write_i2c(0x02,0xd281);
 573   1              write_i2c(0x03,(0x0018|fm_fre));
 574   1              delay_1ms(20);
 575   1      }
 576          
 577          void start()//显示开机字母
 578          {
 579   1          unsigned char i; 
 580   1              write_com_1602(0x80);
 581   1              for(i=0;i<16;i++)
 582   1              {
 583   2                 write_data_1602(dis_table_start[i]);
 584   2                 delay_1ms(1000);
 585   2              }
 586   1              write_com_1602(0xc0);
 587   1              for(i=0;i<16;i++)
 588   1              {
 589   2                 write_data_1602(dis_table_wait[i]);
 590   2                 delay_1ms(800);
 591   2              }
 592   1      }
 593          
 594          void dis_menu(unsigned char num)//显示菜单
 595          {
 596   1          
 597   1          unsigned char i;
 598   1              if(num==0)
 599   1              {
 600   2               dis_clear(1); 
 601   2               write_com_1602(0x80);
 602   2               for(i=0;i<16;i++)
 603   2               {
 604   3                 write_data_1602(dis_table_rxs[i]);
 605   3                 
 606   3               }
 607   2               write_com_1602(0xc0);
 608   2               for(i=0;i<16;i++)
 609   2               {
 610   3                 write_data_1602(dis_table_tx[i]);       
 611   3               }
 612   2              }
 613   1              if(num==1)
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 11  

 614   1              {
 615   2                dis_clear(1);
 616   2                write_com_1602(0x80);
 617   2               for(i=0;i<16;i++)
 618   2               {
 619   3                write_data_1602(dis_table_rx[i]);  
 620   3               }
 621   2               write_com_1602(0xc0);
 622   2               for(i=0;i<16;i++)
 623   2               {
 624   3                 write_data_1602(dis_table_txs[i]);
 625   3      
 626   3               }
 627   2              }
 628   1              if(num==2)
 629   1              {
 630   2                dis_clear(1);
 631   2                write_com_1602(0x80);
 632   2               for(i=0;i<16;i++)
 633   2               {
 634   3                write_data_1602(dis_table_rx_autos[i]);  
 635   3               }
 636   2               write_com_1602(0xc0);
 637   2               for(i=0;i<16;i++)
 638   2               {
 639   3                 write_data_1602(dis_table_rx_manual[i]);
 640   3      
 641   3               }
 642   2              }
 643   1              if(num==3)
 644   1              {
 645   2                dis_clear(1);
 646   2                write_com_1602(0x80);
 647   2               for(i=0;i<16;i++)
 648   2               {
 649   3                write_data_1602(dis_table_rx_auto[i]);  
 650   3               }
 651   2               write_com_1602(0xc0);
 652   2               for(i=0;i<16;i++)
 653   2               {
 654   3                 write_data_1602(dis_table_rx_manuals[i]);
 655   3      
 656   3               }
 657   2              }
 658   1      }
 659          //void init_stc12c5608() //初始化单片机I0
 660          //{
 661          //    P1M0=0x07;
 662          //      P1M1=0x06;
 663          //      P3M0=0x00;
 664          //      P3M1=0x80;
 665          //}
 666          void function() interrupt 1 
 667          {
 668   1         TH0 = (65536 - 20000) / 256;//载入高8位初值
 669   1         TL0 = (65536 - 20000) % 256;//载入低8位初值  
 670   1         dis_rssi();
 671   1      }
 672          void main()
 673          {        
 674   1          unsigned int fm_fre=0x0000,power_tx=0x0000;
 675   1              unsigned char key_num=0;
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 12  

 676   1              bit seek_mode=0,select=0,tf=1;
 677   1          TMOD = 0x01;//设置定时器0 工作方式0
 678   1          TH0 = (65536 - 20000) / 256;//载入高8位初值
 679   1          TL0 = (65536 - 20000) % 256;//载入低8位初值    
 680   1          ET0  =1;//开定时器中断。为0则表示关闭！
 681   1          TR0 =1; //启动定时器
 682   1              EA =0;//开总中断
 683   1              led=0;
 684   1              init_1602();
 685   1              start();
 686   1      //    init_stc12c5608();        
 687   1              init_i2c();
 688   1              set_volume(0x0007);
 689   1              dis_clear(1);
 690   1              dis_menu(0);
 691   1              while(1)
 692   1              { 
 693   2                   key_num=scan_key();
 694   2                                
 695   2                   if(key_num==1)//有确认按键按下
 696   2                       {           
 697   3                                  if(select==0)//就为接受模式
 698   3                                    { 
 699   4                                                    dis_clear(1);
 700   4                                    dis_menu(2);
 701   4                                                        write_i2c(0x40,0x0000);
 702   4                                                        tf=1;
 703   4                                                        while(tf)
 704   4                                                              {
 705   5                                                                  key_num=scan_key();
 706   5                                                                      if(key_num==1)
 707   5                                                                      {
 708   6                                                                           if(seek_mode==0)   //自动搜台
 709   6                                                                               { 
 710   7                                                                                EA=0;
 711   7                                                                        fm_fre=auto_seek(fm_fre,1);
 712   7                                                                                dis_clear(1);
 713   7                                                                                dis_volume();
 714   7                                                                                dis_fm_fre(0);
 715   7                                                                                dis_mode(0);
 716   7                                                                                EA=1;
 717   7                                                                                tf=1;
 718   7                                                                while(tf)
 719   7                                                     {
 720   8                                                                       key_num=scan_key();
 721   8                                                                                   if(key_num==1)               //退回到上一级
 722   8                                                                                    { EA=0;
 723   9                                                                                      dis_clear(1);
 724   9                                                                                      dis_menu(0);
 725   9                                                                                                      select=0;
 726   9                                                                                                      seek_mode=0;
 727   9                                                                                          tf=0;
 728   9                                                                                    }
 729   8      
 730   8                                                                           if(key_num==2)     //向上搜索
 731   8                                                                            {
 732   9                                                                              EA=0;
 733   9                                                                                  fm_fre=auto_seek(fm_fre,1);
 734   9                                                                                          dis_clear(1);
 735   9                                                                                          dis_volume();
 736   9                                                                                          dis_fm_fre(0);
 737   9                                                                                                      dis_mode(0);
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 13  

 738   9                                                                                          EA=1;
 739   9                                                                            }
 740   8                                                                                   if(key_num==3)      //向下搜索
 741   8                                                                            {
 742   9                                                                              EA=0;
 743   9                                                                                  fm_fre=auto_seek(fm_fre,0);
 744   9                                                                                          dis_clear(1);
 745   9                                                                                          dis_volume();
 746   9                                                                                          dis_fm_fre(0);
 747   9                                                                                                      dis_mode(0);
 748   9                                                                                          EA=1;
 749   9                                                                            }
 750   8                                                                        
 751   8                                                             }
 752   7                                                                              }
 753   6                                                                              else    //否则为手动搜台
 754   6                                                                              {       
 755   7                                                                                  EA=0;
 756   7                                                                                  dis_wait();
 757   7                                                                                      set_fm_fre_rx(fm_fre);
 758   7                                                                                      dis_clear(1);
 759   7                                                                                  dis_volume();
 760   7                                                                                  dis_fm_fre(0);
 761   7                                                                                      dis_mode(0);
 762   7                                                                                  EA=1;
 763   7                                                                                      tf=1;
 764   7                                                                                  while(tf)
 765   7                                                      {
 766   8                                                                                         key_num=scan_key();
 767   8                                                                                                 if(key_num==1)                 //退回到上一级
 768   8                                                                                    { EA=0;
 769   9                                                                                      dis_clear(1);
 770   9                                                                                      dis_menu(0);
 771   9                                                                                                      select=0;
 772   9                                                                                                      seek_mode=0;
 773   9                                                                                          tf=0;                                                                                               
 774   9                                                                                    }
 775   8                                                                                                 if(key_num==2)
 776   8                                                                                                 {
 777   9                                                                                                   EA=0; 
 778   9                                                                                                                               
 779   9                                                                                                       fm_fre+=10;
 780   9                                                                                                       set_fm_fre_rx(fm_fre); 
 781   9                                                                                                       if(fm_fre>=210)
 782   9                                                                                                       {
 783  10                                                                                                       fm_fre=0;
 784  10                                                                                                       set_fm_fre_rx(fm_fre);
 785  10                                                                                                       }  
 786   9                                                                                                       dis_clear(1);
 787   9                                                                                           dis_volume();
 788   9                                                                                           dis_fm_fre(0);
 789   9                                                                                                       dis_mode(0);
 790   9                                                                                           EA=1;
 791   9                                                                                                 } 
 792   8                                                                                                 if(key_num==3)
 793   8                                                                                                 {
 794   9                                                                                                   EA=0;
 795   9                                                                                                       if((fm_fre%10)>=9)
 796   9                                                                                                       {
 797  10                                                                                                       fm_fre-=10;
 798  10                                                                                                       set_fm_fre_rx(fm_fre);
 799  10                                                                                                       }              
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 14  

 800   9                                                                                                       fm_fre+=1;                             
 801   9                                                                                                       set_fm_fre_rx(fm_fre);                                                          
 802   9                                                                                                       dis_clear(1);
 803   9                                                                                           dis_volume();
 804   9                                                                                           dis_fm_fre(0);
 805   9                                                                                                       dis_mode(0);
 806   9                                                                                           EA=1;
 807   9                                                                                                 } 
 808   8                                                                                  }
 809   7                                                                              }
 810   6                                                                      }
 811   5                                                                      if(key_num==2)
 812   5                                                                      {    
 813   6                                                                           EA=0;
 814   6                                                                           dis_clear(1); 
 815   6                                                   seek_mode=0;
 816   6                                                           dis_menu(2);
 817   6                                                                      }
 818   5                                                                      if(key_num==3)
 819   5                                                                      {    
 820   6                                                                           EA=0;
 821   6                                                                           dis_clear(1); 
 822   6                                                   seek_mode=1;
 823   6                                                           dis_menu(3);
 824   6                                                                      }
 825   5                                                               }       
 826   4                                   }  
 827   3                                         if(select==1)//否则就是发射模式
 828   3                                              {               
 829   4                                                              fm_fre=0x0000;
 830   4                                                      EA=0;
 831   4                                                              tf=1;
 832   4                                                      dis_wait();     
 833   4                                                              write_i2c(0x40,0x0001);         
 834   4                                                              write_i2c(0x02,0xd281); 
 835   4                                                              write_i2c(0x03,0x0018); 
 836   4                                                              dis_clear(1);
 837   4                                                              dis_power_tx(0);
 838   4                                                              key_num=0;
 839   4                                                              while(tf)
 840   4                                                              {
 841   5                                                                  key_num=scan_key();
 842   5                                                                      if(key_num==1)            //退回到上一级
 843   5                                                                      {                                                                              
 844   6                                                                                dis_clear(1);
 845   6                                                                                dis_power_tx(1);
 846   6                                                                        dis_mode(1);
 847   6                                                                        dis_fm_fre(1);
 848   6                                                                        while(tf)
 849   6                                                         {
 850   7                                                                                         key_num=scan_key();
 851   7                                                                                                 if(key_num==1)                 //退回到上一级
 852   7                                                                                     {                                                                               
 853   8                                                                                                      write_i2c(0x02,0x0000);
 854   8                                                                                                      select=0;
 855   8                                                                                          tf=0; 
 856   8                                                                                                      dis_clear(1);
 857   8                                                                      dis_menu(0);                                                    
 858   8                                                                                     }
 859   7                                                                                                 if(key_num==2)
 860   7                                                                                                 {             
 861   8                                                                                                       fm_fre+=10;
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 15  

 862   8                                                                                                       set_fm_fre_tx(fm_fre); 
 863   8                                                                                                        
 864   8                                                                                                   if(fm_fre>=320)
 865   8                                                                                                       {
 866   9                                                                                                       fm_fre=0;
 867   9                                                                                                       set_fm_fre_tx(fm_fre);
 868   9                                                                                                       }      
 869   8                                                                                                       dis_clear(1);
 870   8                                                                                          // dis_volume(); 
 871   8                                                                                                       dis_power_tx(1);                                                                                    
 872   8                                                                                                       dis_mode(1);
 873   8                                                                                                       dis_fm_fre(1);
 874   8                                                                                         
 875   8                                                                                                 } 
 876   7                                                                                                 if(key_num==3)
 877   7                                                                                                 {
 878   8                                                                                                      
 879   8                                                                                                        if((fm_fre%10)>=9)
 880   8                                                                                                       {
 881   9                                                                                                       fm_fre-=10;
 882   9                                                                                                       set_fm_fre_tx(fm_fre);
 883   9                                                                                                       }
 884   8                                                                                                       fm_fre+=1;                                     
 885   8                                                                                                       set_fm_fre_tx(fm_fre);                                                          
 886   8                                                                                                       dis_clear(1);
 887   8                                                                                           dis_power_tx(1);
 888   8                                                                                                       dis_mode(1);
 889   8                                                                                            dis_fm_fre(1);
 890   8                                                                                                  } 
 891   7                                                                  }
 892   6                                                                              }
 893   5                                                                              if(key_num==2)
 894   5                                                                              {
 895   6                                                                                 power_tx+=16;
 896   6                                                                                 set_power_tx(power_tx);
 897   6                                                                                 if(power_tx>=64|power_tx<=0)
 898   6                                                                                 {power_tx=0;}
 899   6                                                                                 dis_clear(1);
 900   6                                                                                 dis_power_tx(0);
 901   6                                                                              }
 902   5                                                               }
 903   4                                              }
 904   3                       }
 905   2                       if(key_num==2) 
 906   2                       { 
 907   3                                                                      
 908   3                              dis_clear(1); 
 909   3                              select=0;
 910   3                                      dis_menu(0);
 911   3                                      
 912   3                              
 913   3                       }
 914   2                        if(key_num==3) 
 915   2                       {   
 916   3                               
 917   3                                      dis_clear(1); 
 918   3                                      select=1;
 919   3                                      dis_menu(1);
 920   3                                       
 921   3                       }
 922   2                       key_num=0;     
 923   2                                 
C51 COMPILER V9.00   收音_                                                                03/01/2014 20:19:52 PAGE 16  

 924   2               }
 925   1      } 
 926                  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2900    ----
   CONSTANT SIZE    =    278    ----
   XDATA SIZE       =   ----      25
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       9
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
